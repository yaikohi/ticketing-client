import{fromJSON as E,crossSerializeStream as L,getCrossReferenceHeader as O}from"seroval";import{CustomEventPlugin as g,DOMExceptionPlugin as h,EventPlugin as y,FormDataPlugin as w,HeadersPlugin as R,ReadableStreamPlugin as P,RequestPlugin as S,ResponsePlugin as v,URLSearchParamsPlugin as b,URLPlugin as x}from"seroval-plugins/web";import{sharedConfig as T}from"solid-js";import{provideRequestEvent as H}from"solid-js/web/storage";import{g as $,s as d}from"./middleware.js";import{eventHandler as k}from"h3";import"unctx";import"node:async_hooks";const p="Invariant Violation",{setPrototypeOf:C=function(t,r){return t.__proto__=r,t}}=Object;class m extends Error{framesToPop=1;name=p;constructor(r=p){super(typeof r=="number"?`${p}: ${r} (see https://github.com/apollographql/invariant-packages)`:r),C(this,m.prototype)}}function I(t,r){if(!t)throw new m(r)}function U(t){const n=t.length.toString(16),s="00000000".substring(0,8-n.length)+n;return new TextEncoder().encode(`;0x${s};${t}`)}function B(t,r){return new ReadableStream({start(n){L(r,{scopeId:t,plugins:[g,h,y,w,R,P,S,v,b,x],onSerialize(s,a){n.enqueue(U(a?`(${O(t)},${s})`:s))},onDone(){n.close()},onError(s){n.error(s)}})}})}async function D(t){const r=$(t),n=r.request,s=n.headers.get("x-server-id"),a=n.headers.get("x-server-instance"),c=new URL(n.url);let f,l;if(s)I(typeof s=="string","Invalid server function"),[f,l]=s.split("#");else if(f=c.searchParams.get("id"),l=c.searchParams.get("name"),!f||!l)throw new Error("Invalid request");const q=(await globalThis.MANIFEST["server-fns"].chunks[f].import())[l];let i=[];if(!a||t.method==="GET"){const e=c.searchParams.get("args");e&&JSON.parse(e).forEach(o=>i.push(o))}if(t.method==="POST"){const e=n.headers.get("content-type");if(e.startsWith("multipart/form-data")||e.startsWith("application/x-www-form-urlencoded"))i.push(await new Request(n,{...n,body:r.node.req.body}).formData());else{const o=new Request(n,{...n,body:r.node.req.body});i=E(await o.json(),{plugins:[g,h,y,w,R,P,S,v,b,x]})}}try{let e=await H(r,()=>(T.context={event:r},q(...i)));if(e instanceof Response){if(e.status===302)return new Response(null,{status:a?204:302,headers:{Location:e.headers.get("Location")}});if(e.headers)for(const[o,u]of e.headers.entries())d(t,o,u);e.customBody?e=await e.customBody():e.body==null&&(e=void 0)}if(!a){const o=e instanceof Error,u=new URL(n.headers.get("referer"));return new Response(null,{status:302,headers:{Location:u.toString(),...e?{"Set-Cookie":`flash=${JSON.stringify({url:c.pathname+encodeURIComponent(c.search),result:o?e.message:e,error:o,input:[...i.slice(0,-1),[...i[i.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}return typeof e=="string"?new Response(e):(d(t,"content-type","text/javascript"),B(a,e))}catch(e){if(e instanceof Response){if(e.status===302)return new Response(null,{status:a?204:302,headers:{Location:e.headers.get("Location")}});if(e.headers)for(const[o,u]of e.headers.entries())d(t,o,u);e.customBody?e=await e.customBody():e.body==null&&(e=void 0)}return e}}const A=k(D);export{A as default};
