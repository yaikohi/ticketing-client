import{H3Event as p,setResponseStatus as E,getResponseHeader as x,setResponseHeader as T,appendResponseHeader as A,sendRedirect as $,getCookie as P,setCookie as _,setHeader as O,removeResponseHeader as k,getRequestURL as L,getRequestIP as W,getRequestWebStream as U}from"h3";import{getContext as F}from"unctx";import{AsyncLocalStorage as I}from"node:async_hooks";import{startTransition as M,getOwner as B,onCleanup as K,createSignal as N}from"solid-js";import{isServer as h}from"solid-js/web";import{i as j,m as D,r as X}from"./routing-d4b2a578.js";function z(e){let t;const n=b(e),o={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...o,body:e.node.req.body}):new Request(n,{...o,get body(){return t||(t=Y(e),t)}})}function J(e){return e.web??={request:z(e),url:b(e)},e.web.request}function G(){return ee()}const w=Symbol("$HTTPEvent");function Q(e){return typeof e=="object"&&(e instanceof p||e?.[w]instanceof p||e?.__is_event__===!0)}function r(e){return function(...t){let n=t[0];if(Q(n))t[0]=n instanceof p||n.__is_event__?n:n[w];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=G(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(n)}return e(...t)}}const b=r(L),V=r(W),me=r(E),Re=r(x),ye=r(T),we=r(A),be=r($),Se=r(P),He=r(_),Ce=r(O),Y=r(U),ve=r(k);function Z(){return F("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:I})}function ee(){return Z().use().event}const S=Symbol("h3Event"),i=Symbol("fetchEvent"),H={get(e,t){return t===i?e:e[t]??e[S][t]}};function te(e){const t=J(e);return new Proxy({request:t,clientAddress:V(e),locals:{},[S]:e},H)}function qe(e){return new Proxy({...e[i]},H)}function Ee(e){if(!e[i]){const t=te(e);e[i]=t}return e[i]}const ne=18e4;let f=new Map;h||setInterval(()=>{const e=Date.now();for(let[t,n]of f.entries())!n[3].size&&e-n[0]>ne&&f.delete(t)},3e5);function se(e,t=!0){return M(()=>{const n=Date.now();C(e,o=>{t&&(o[0]=0),oe(o[3],n)})})}function C(e,t){e&&!Array.isArray(e)&&(e=[e]);for(let n of f.keys())(e===void 0||re(n,e))&&t(f.get(n))}function oe(e,t){for(let n of e)n[1](t)}function re(e,t){for(let n of t)if(e.startsWith(n))return!0;return!1}function ae(e){return JSON.stringify(e,(t,n)=>ie(n)?Object.keys(n).sort().reduce((o,s)=>(o[s]=n[s],o),{}):n)}function ie(e){let t;return e!=null&&typeof e=="object"&&(!(t=Object.getPrototypeOf(e))||t===Object.prototype)}const y=new Map;function xe(e){const t=j();return(...n)=>e.apply(t,n)}function Te(e,t){function n(...s){const c=e(...s),[g,m]=N();let R;const d=this;async function u(l){const a=await ue(l,d.navigatorFactory());return a?m({data:a}):R.clear(),a}return d.submissions[1](l=>[...l,R={input:s,url:o,get result(){return g()?.data},get pending(){return!g()},clear(){d.submissions[1](a=>a.filter(q=>q.input!==s))},retry(){m(void 0);const a=e(...s);return a.then(u,u),a}}]),c.then(u,u),c}const o=e.url||t&&`https://action/${t}`||(h?"":`https://action/${ce(e.toString())}`);return v(n,o)}function v(e,t){return e.toString=()=>{if(!t)throw new Error("Client Actions need explicit names if server rendered");return t},e.with=function(...n){const o=function(...c){return e.call(this,...n,...c)},s=new URL(t,D);return s.searchParams.set("args",ae(n)),v(o,(s.origin==="https://action"?s.origin:"")+s.pathname+s.search)},e.url=t,h||(y.set(t,e),B()&&K(()=>y.delete(t))),e}const ce=e=>e.split("").reduce((t,n)=>(t<<5)-t+n.charCodeAt(0)|0,0);async function ue(e,t){let n,o;if(e instanceof Response){if(e.headers.has("X-Revalidate")&&(o=e.headers.get("X-Revalidate").split(",")),e.customBody&&(n=await e.customBody()),X.has(e.status)){const s=e.headers.get("Location")||"/";s.startsWith("http")?window.location.href=s:t(s)}}else n=e;return C(o,s=>s[0]=0),await se(o,!1),n}export{me as a,we as b,Se as c,He as d,Ee as e,be as f,Re as g,Ce as h,y as i,qe as j,Te as k,ve as r,ye as s,xe as u};
